**çº¿ç¨‹æ± è§£å†³çš„é—®é¢˜æ˜¯ä»€ä¹ˆ**  
**
çº¿ç¨‹æ± è§£å†³çš„æ ¸å¿ƒé—®é¢˜å°±æ˜¯èµ„æºç®¡ç†é—®é¢˜ã€‚åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œç³»ç»Ÿä¸èƒ½å¤Ÿç¡®å®šåœ¨ä»»æ„æ—¶åˆ»ä¸­ï¼Œæœ‰å¤šå°‘ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œæœ‰å¤šå°‘èµ„æºéœ€è¦æŠ•å…¥ã€‚è¿™ç§ä¸ç¡®å®šæ€§å°†å¸¦æ¥ä»¥ä¸‹è‹¥å¹²é—®é¢˜ï¼š

1. é¢‘ç¹ç”³è¯·/é”€æ¯èµ„æºå’Œè°ƒåº¦èµ„æºï¼Œå°†å¸¦æ¥é¢å¤–çš„æ¶ˆè€—ï¼Œå¯èƒ½ä¼šéå¸¸å·¨å¤§ã€‚
2. å¯¹èµ„æºæ— é™ç”³è¯·ç¼ºå°‘æŠ‘åˆ¶æ‰‹æ®µï¼Œæ˜“å¼•å‘ç³»ç»Ÿèµ„æºè€—å°½çš„é£é™©ã€‚
3. ç³»ç»Ÿæ— æ³•åˆç†ç®¡ç†å†…éƒ¨çš„èµ„æºåˆ†å¸ƒï¼Œä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚


```java
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          ThreadFactory threadFactory) {
    this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
         threadFactory, defaultHandler);
}
```

çº¿ç¨‹æ± Â ThreadPoolExecutor æ„é€ å‡½æ•°æœ‰ 5 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š
**corePoolSize**ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°  
**maximumPoolSize**ï¼šçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°  
**keepAliveTime**ï¼šéæ ¸å¿ƒçº¿ç¨‹å­˜æ´»æ—¶é—´  
**unit**ï¼šå­˜æ´»æ—¶é—´å•ä½  
**workQueue**ï¼šå·¥ä½œé˜Ÿåˆ—ï¼ˆé˜»å¡é˜Ÿåˆ—ï¼‰  
**threadFactory**ï¼šçº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹  

æ ¸å¿ƒçº¿ç¨‹ä¼šä¸€ç›´å­˜æ´»ï¼Œå³ä½¿åœ¨ç©ºé—²çŠ¶æ€ã€‚ä½†å¦‚æœè®¾ç½®äº†Â Â **allowCoreThreadTimeOut** ï¼Œé‚£ä¹ˆæ ¸å¿ƒçº¿ç¨‹ä¹Ÿä¼šæœ‰è¶…æ—¶ã€‚

çº¿ç¨‹æ± æ‰§è¡Œæœ‰ 2 ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯Â **submit** å’ŒÂ **execute**ï¼Œsubmit å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨Â executeï¼ŒåŒºåˆ«åœ¨äºÂ submit æ–¹æ³•æœ‰è¿”å›åŒ…è£…å¥½çš„ Runnableï¼š

```java
public Future<?> submit(Runnable task) {
    if (task == null) throw new NullPointerException();
    RunnableFuture<Void> ftask = newTaskFor(task, null);
    execute(ftask);
    return ftask;
}
```


**çº¿ç¨‹çš„åˆ›å»ºæ–¹å¼ï¼š**  


1. é¦–å…ˆæ£€æµ‹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯RUNNINGï¼Œåˆ™ç›´æ¥æ‹’ç»ï¼Œçº¿ç¨‹æ± è¦ä¿è¯åœ¨RUNNINGçš„çŠ¶æ€ä¸‹æ‰§è¡Œä»»åŠ¡ã€‚  
2. å¦‚æœworkerCount < corePoolSizeï¼Œåˆ™åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ã€‚  
3. å¦‚æœworkerCount >= corePoolSizeï¼Œä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°è¯¥é˜»å¡é˜Ÿåˆ—ä¸­ã€‚
4. å¦‚æœworkerCount >= corePoolSize && workerCount < maximumPoolSizeï¼Œä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ã€‚
5. å¦‚æœworkerCount >= maximumPoolSizeï¼Œå¹¶ä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—å·²æ»¡, åˆ™æ ¹æ®æ‹’ç»ç­–ç•¥æ¥å¤„ç†è¯¥ä»»åŠ¡, é»˜è®¤çš„å¤„ç†æ–¹å¼æ˜¯ç›´æ¥æŠ›å¼‚å¸¸ã€‚

![image.png](../res/çº¿ç¨‹æ± 1.png)


**executeï¼š**

```java
public void execute(Runnable command) {
    if (command == null)
        throw new NullPointerException();
    //è·å¾—å½“å‰çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¯¹åº”çš„äºŒè¿›åˆ¶çŠ¶æ€ç 
    int c = ctl.get(); 
    //å¦‚æœå½“å‰çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°
    if (workerCountOf(c) < corePoolSize) {
        //åˆ™åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œåˆ›å»ºæˆåŠŸç›´æ¥è¿”å›
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    //å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ˜¯ Runningï¼Œå¹¶ä¸”å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­æˆåŠŸ
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        //åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€,å¦‚æœä¸æ˜¯RUNNINGçŠ¶æ€,ç›´æ¥ç§»é™¤é˜Ÿåˆ—ä¸­
        if (! isRunning(recheck) && remove(command))
            reject(command);
        //å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡ä¸º0,åˆ™å•ç‹¬åˆ›å»ºçº¿ç¨‹,è€Œä¸æŒ‡å®šä»»åŠ¡.
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    //å¦åˆ™å°è¯•åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡,å¦‚æœåˆ›å»ºå¤±è´¥,è°ƒç”¨reject()æ–¹æ³•.
    else if (!addWorker(command, false))
        reject(command);
}
```
![20170327011301115.png](https://cdn.nlark.com/yuque/0/2020/png/450005/1585553961796-71176a9e-82ee-4f4d-9545-4dada979306e.png#align=left&display=inline&height=894&originHeight=894&originWidth=756&size=65486&status=done&style=none&width=756)

addWorker æ–¹æ³•å°±æ˜¯åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•ï¼ŒaddWorker æœ‰ä¸¤ä¸ªå‚æ•°ã€‚  
ç¬¬ä¸€ä¸ªå‚æ•° Runnableï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™æ˜¯åˆ›å»ºåæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¦‚æœä¸º nullï¼Œåˆ™ä¸æŒ‡å®šä»»åŠ¡ï¼Œåªæ˜¯å•ç‹¬çš„åˆ›å»ºçº¿ç¨‹ã€‚  
ç¬¬äºŒä¸ªå‚æ•° coreï¼Œè¡¨ç¤ºæ˜¯å¦åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹ã€‚

```java
private boolean addWorker(Runnable firstTask, boolean core) {
    retry:
    for (;;) {
        int c = ctl.get();
        int rs = runStateOf(c);  //çº¿ç¨‹çŠ¶æ€

        // Check if queue empty only if necessary.
        if (rs >= SHUTDOWN &&
            ! (rs == SHUTDOWN &&
               firstTask == null &&
               ! workQueue.isEmpty()))
            return false;

        for (;;) {
            int wc = workerCountOf(c); //è·å–å½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡
            if (wc >= CAPACITY ||
                wc >= (core ? corePoolSize : maximumPoolSize))
                return false;
            if (compareAndIncrementWorkerCount(c))
                break retry;
            c = ctl.get();  // Re-read ctl
            if (runStateOf(c) != rs)
                continue retry;
            // else CAS failed due to workerCount change; retry inner loop
        }
    }
   //...
}
```

addWorker é€»è¾‘åˆ†ä¸º 2 éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯åˆ›å»ºçº¿ç¨‹ğŸ’°ä¸€äº›éªŒè¯é€»è¾‘ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯åˆ›å»ºçº¿ç¨‹é€»è¾‘ï¼Œå…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ†ï¼Œç”±ä¸¤ä¸ª for å¾ªç¯ç»„æˆï¼Œè¿™æ˜¯é‡Œä½¿ç”¨é‡Œ CAS ç®—æ³•ã€‚
Â 
é¦–å…ˆåˆ¤æ–­çº¿ç¨‹çŠ¶æ€å¦‚æœå·²ç»å¤„äº**Â STOP æˆ–è€…å³å°† STOP çš„çŠ¶æ€ **æˆ–è€… **å¤„äºÂ SHUTDOWN çŠ¶æ€ï¼Œå¹¶ä¸”ä¼ é€’çš„ä»»åŠ¡Â firstTask ä¸ºç©ºï¼Œå¹¶ä¸”é˜Ÿåˆ—Â workQueue ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œ**ç›´æ¥è¿”å› falseï¼Œä¸éœ€è¦åˆ›å»ºçº¿ç¨‹ã€‚
ï¼ˆSHUTDOWN æ˜¯å…³æ‰çš„æ„æ€ï¼‰

å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡è¶…å¤šÂ CAPACITY æœ€å¤§å€¼ï¼Œæˆ–è€…è¶…å¤šæ ¸å¿ƒçº¿ç¨‹æ•°æˆ–è€…æœ€å¤§çº¿ç¨‹æ•°ï¼Œä¸éœ€è¦åˆ›å»ºçº¿ç¨‹

compareAndIncrementWorkerCount æ–¹æ³•æ˜¯åˆ¤æ–­ çº¿ç¨‹æ± çŠ¶æ€çš„ç»Ÿè®¡æ›´æ–°æ˜¯å¦æˆåŠŸï¼ŒæˆåŠŸå°±è·³å‡ºå¾ªç¯ç»§ç»­æ‰§è¡Œ

retryÂ ç±»ä¼¼ goto,æ˜¯Javaçš„æ ‡è¯†ç¬¦ã€‚

addWorker åˆ›å»ºçº¿ç¨‹éƒ¨åˆ†ï¼š

```java
boolean workerStarted = false;
boolean workerAdded = false;
Worker w = null;
try {
    //Worker æ˜¯ä¸€ä¸ª Runnable ï¼ŒåŒ…è£…äº†çº¿ç¨‹ Thread
    w = new Worker(firstTask);
    final Thread t = w.thread;
    if (t != null) {
        //åŠ é”
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            //è·å–çº¿ç¨‹æ± çŠ¶æ€
            int rs = runStateOf(ctl.get());
			//åªæœ‰çº¿ç¨‹æ± åœ¨ RUNNABLE çŠ¶æ€æˆ–è€…åœ¨ SHUTDOWN çŠ¶æ€å¹¶ä¸”ä»»åŠ¡ä¸ºnullæ—¶ï¼Œæ·»åŠ çº¿ç¨‹
            if (rs < SHUTDOWN ||
                (rs == SHUTDOWN && firstTask == null)) {
                if (t.isAlive()) // precheck that t is startable
                    throw new IllegalThreadStateException();
                workers.add(w);
                //å®¹é‡åˆ¤æ–­
                int s = workers.size();
                if (s > largestPoolSize)
                    largestPoolSize = s;
                workerAdded = true;
            }
        } finally {
            mainLock.unlock();
        }
        //å¦‚æœçº¿ç¨‹å·²ç»æ·»åŠ æˆåŠŸï¼Œåˆ™è°ƒç”¨startå¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸”è®¾ç½®æ ‡å¿— workerStarted
        if (workerAdded) {
            t.start();
            workerStarted = true;
        }
    }
} finally {
     //æœ€åå¦‚æœçº¿ç¨‹æ²¡æœ‰å¼€å§‹,å°±åˆ†å‘åˆ°æ·»åŠ çº¿ç¨‹å¤±è´¥,é€šè¿‡æ ‡å¿—ä½æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ·»åŠ æˆåŠŸ.
    if (! workerStarted)
        addWorkerFailed(w);
}
//å¦‚æœæ·»åŠ æˆåŠŸå°±è¿”å›true,å¦åˆ™æ·»åŠ å¤±è´¥å°±è¿”å›false.
return workerStarted;
}
```

1. Worker å®ç°äº†Â Runnableï¼Œå¹¶ä¸”åŒ…è£…äº†ç”±çº¿ç¨‹å·¥å‚åˆ›å»ºçš„çº¿ç¨‹ Thread
2. æ·»åŠ çº¿ç¨‹çš„è¿‡ç¨‹æ˜¯åŠ é”çš„
3. åªæœ‰åœ¨çº¿ç¨‹æ± ä¸º RUNNABLE çŠ¶æ€æˆ–è€…åœ¨ SHUTDOWN çŠ¶æ€å¹¶ä¸”ä»»åŠ¡ä¸º null æ—¶ï¼Œæ‰ä¼šæ·»åŠ çº¿ç¨‹
4. æ·»åŠ æˆåŠŸä¼šä¿®æ”¹æ ‡å¿—ä½Â workerAdded ä¸º trueï¼Œå¹¶ä¸”è°ƒç”¨çº¿ç¨‹çš„ start æ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¿®æ”¹Â workerStarted ä¸º true
5. å¦‚æœÂ workerStarted ä¸º falseï¼Œå³çº¿ç¨‹æ‰§è¡Œæ²¡å¼€å§‹ï¼Œåˆ™åˆ†å‘åˆ°æ·»åŠ çº¿ç¨‹å¤±è´¥é€»è¾‘

**Worker**

```java
final Thread thread;

Worker(Runnable firstTask) {
    setState(-1); // inhibit interrupts until runWorker
    this.firstTask = firstTask;
    this.thread = getThreadFactory().newThread(this);
}
```
**
ä¹‹å‰è¯´åˆ°ï¼ŒÂ Worker å®ç°äº†Â Runnableï¼Œå¹¶ä¸”åŒ…è£…äº†ç”±çº¿ç¨‹å·¥å‚åˆ›å»ºçš„çº¿ç¨‹ Threadï¼Œå½“è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼šå›è°ƒ Worker çš„ run æ–¹æ³•ï¼Œæœ€åæ‰§è¡ŒÂ runWorker æ–¹æ³•ï¼š

```java
public void run() {
    runWorker(this);
}
final void runWorker(Worker w) {
    Thread wt = Thread.currentThread();
    Runnable task = w.firstTask;
    w.firstTask = null;
    w.unlock(); // allow interrupts
    boolean completedAbruptly = true;
    try {
        while (task != null || (task = getTask()) != null) {
            w.lock();
            //ä¸­æ–­åˆ¤æ–­
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &&
                  runStateAtLeast(ctl.get(), STOP))) &&
                !wt.isInterrupted())
                wt.interrupt();
            try {
                beforeExecute(wt, task);
                Throwable thrown = null;
                try {
                    task.run();
                } catch (RuntimeException x) {
                    thrown = x; throw x;
                } catch (Error x) {
                    thrown = x; throw x;
                } catch (Throwable x) {
                    thrown = x; throw new Error(x);
                } finally {
                    afterExecute(task, thrown);
                }
            } finally {
                task = null;
                w.completedTasks++;
                w.unlock();
            }
        }
        completedAbruptly = false;
    } finally {
        processWorkerExit(w, completedAbruptly);
    }
}
```

1. å¾ªç¯è°ƒç”¨ getTask æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–æ–°ä»»åŠ¡ã€‚
2. å¦‚æœæ± æ­£åœ¨åœæ­¢ï¼Œè¯·ç¡®ä¿çº¿ç¨‹è¢«ä¸­æ–­ï¼› å¦‚æœæ²¡æœ‰ï¼Œè¯·ç¡®ä¿çº¿ç¨‹ä¸è¢«ä¸­æ–­ã€‚ è¿™éœ€è¦åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹é‡æ–°æ£€æŸ¥ä»¥å¤„ç†shutdownNowç«èµ›ï¼ŒåŒæ—¶æ¸…é™¤ä¸­æ–­.
3. beforeExecute å’ŒÂ afterExecute åˆ†åˆ«å¯ä»¥åœ¨æ‰§è¡Œä»»åŠ¡å‰ååšäº›æ“ä½œ
4. çº¿ç¨‹é€€å‡ºåï¼Œè°ƒç”¨Â processWorkerExit åšåç»­å¤„ç†

**çº¿ç¨‹æ± çš„å¤ç”¨**  
 
çº¿ç¨‹æ± çº¿ç¨‹å¤ç”¨éœ€è¦çœ‹åˆ°åœ¨é˜Ÿåˆ—ä¸­å–çº¿ç¨‹çš„æ–¹æ³• getTask

```java
private Runnable getTask() {
    boolean timedOut = false; // Did the last poll() time out?

    for (;;) {
        int c = ctl.get();
        int rs = runStateOf(c);

        // Check if queue empty only if necessary.
        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {
            decrementWorkerCount();
            return null;
        }

        int wc = workerCountOf(c);

        // Are workers subject to culling?
        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;

        if ((wc > maximumPoolSize || (timed && timedOut))
            && (wc > 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                return null;
            continue;
        }

        try {
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
            workQueue.take();
            if (r != null)
                return r;
            timedOut = true;
        } catch (InterruptedException retry) {
            timedOut = false;
        }
    }
}
```

1. å¯åŠ¨ä¸€ä¸ªæ­»å¾ªç¯ï¼Œé¦–å…ˆåˆ¤æ–­ä¸€ä¸‹çº¿ç¨‹æ± çŠ¶æ€ï¼Œä»…åœ¨å¿…è¦æ—¶æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœç©ºåˆ™è¿”å› null
2. é€šè¿‡ timed åˆ¤æ–­æ˜¯å¦å¼€å¯æ—¶é—´æ£€æµ‹æœºåˆ¶ï¼Œå¦‚æœè®¾ç½®äº†Â allowCoreThreadTimeOut æˆ–è€…å·¥ä½œçº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°åˆ™å¼€å¯ã€‚
3. å¦‚æœ timed ä¸º true åˆ™é€šè¿‡é˜»å¡é˜Ÿåˆ—çš„** poll(long timeout, TimeUnit unit)Â **æ–¹æ³•åœ¨æ—¶é—´Â keepAliveTime å†…å–å‡ºå…ƒç´ ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨ take æ–¹æ³•å–å‡ºã€‚
4. å¦‚æœå–å‡ºæˆåŠŸï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™æ ‡è®°ä¸º timedOut è¶…æ—¶

æ€»ç»“ï¼šä»»åŠ¡åœ¨å¹¶ä¸åªæ‰§è¡Œåˆ›å»ºæ—¶æŒ‡å®šçš„ firstTask ç¬¬ä¸€ä»»åŠ¡ï¼Œè¿˜ä¼šä»ä»»åŠ¡é˜Ÿåˆ—çš„ä¸­è‡ªå·±ä¸»åŠ¨å–ä»»åŠ¡æ‰§è¡Œï¼Œè€Œä¸”æ˜¯æœ‰/æ— æ—¶é—´é™å®šçš„é˜»å¡ç­‰å¾…ï¼Œä¿è¯çº¿ç¨‹çš„å­˜æ´»ã€‚


**æ‹’ç»ç­–ç•¥**

åœ¨Â execute æ–¹æ³•ä¸­ï¼Œå¦‚æœ addWorked å¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨Â reject(Runnable command) æ–¹æ³•ï¼š

```java
final void reject(Runnable command) {
    handler.rejectedExecution(command, this);
}
```

handler çš„ç±»å‹æ˜¯Â RejectedExecutionHandlerï¼Œæ˜¯ä¸€ä¸ªæ¥å£ï¼Œé»˜è®¤æœ‰å››ä¸ªå®ç°ï¼Œå³ 4 ç§æ‹’ç»ç­–ç•¥ï¼š

| å®ç°ç±» | è¯´æ˜ |  |
| --- | --- | --- |
| CallerRunsPolicy | ç”±è°ƒç”¨çº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ |  |
| AbortPolicy | ä¸¢å¼ƒæ–°ä»»åŠ¡ï¼Œå¹¶æŠ›å‡ºÂ RejectedExecutionException |  |
| DiscardPolicy | ä¸åšä»»ä½•æ“ä½œï¼Œç›´æ¥ä¸¢å¼ƒæ–°ä»»åŠ¡ |  |
| DiscardOldestPolicy | ä¸¢å¼ƒé˜Ÿåˆ—é˜Ÿé¦–å…ƒç´ ï¼Œå¹¶æ‰§è¡Œæ–°ä»»åŠ¡ |  |


çº¿ç¨‹æ± é»˜è®¤å®ç°çš„æ‹’ç»ç­–ç•¥æ˜¯**Â defaultHandler =Â AbortPolicyï¼Œ**å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æˆ–è€…Â setRejectedExecutionHandler æ–¹æ³•ä¿®æ”¹ã€‚

**android ä¸­å¸¸ç”¨çš„çº¿ç¨‹æ± åˆ†ç±»**
 
FixedThreadPool

```java
 public static ExecutorService newFixedThreadPool(int nThreads) {
     return new ThreadPoolExecutor(
         nThreads, nThreads,
         0L, TimeUnit.SECONDS,
         new LinkedBlockingQueue<Runnable>()
     );
 }
```

ç‰¹ç‚¹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ç›¸ç­‰ï¼Œå³å…¨éƒ¨éƒ½æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚æ²¡è¶…æ—¶æ—¶é—´ã€‚è¿™æ„å‘³è¿™å®ƒèƒ½å¤Ÿæ›´å¿«é€Ÿçš„å“åº”å¤–ç•Œè¯·æ±‚ã€‚æ’é˜Ÿç­–ç•¥ä½¿ç”¨Â LinkedBlockingQueue

CacheThreadPool

```java
public static  ExecutorService newCacheThreadPool(){
    return  new ThreadPoolExecutor(
        0,Integer.MAX_VALUE,
        60L,TimeUnit.SECONDS,
        new SynchronousQueue<Runnable>()
    );
}
```

ç‰¹ç‚¹ï¼šæ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œçº¿ç¨‹æ•°æœ€å¤§æ˜¯Â Integer.MAX_VALUEï¼Œè¶…æ—¶æ—¶é—´æ˜¯ 60 ç§’ï¼Œæ„å‘³ç€å½“çº¿ç¨‹æ± é‡Œé¢æ‰€æœ‰çº¿ç¨‹éƒ½å¤„äºæ´»è·ƒçŠ¶æ€æ—¶ï¼Œæ‰ä¼šæ–°å»ºçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œå¦åˆ™éƒ½æ˜¯å¤ç”¨ç©ºé—²çº¿ç¨‹å»å¤„ç†ï¼Œæ¯”è¾ƒé€‚åˆå¤„ç†å¤§é‡ä¸”è€—æ—¶è¾ƒçŸ­çš„ä»»åŠ¡ã€‚æ’é˜Ÿç­–ç•¥æ˜¯Â SynchronousQueue

ScheduledThreadPool

```java
public ScheduledThreadPoolExecutor(int corePoolSize) {
    super(corePoolSize, Integer.MAX_VALUE,
          DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,
          new DelayedWorkQueue());
}
```

ç‰¹ç‚¹ï¼šæŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯å›ºå®šçš„ï¼Œçº¿ç¨‹æ•°æœ€å¤§ä¹Ÿæ˜¯Â Â Integer.MAX_VALUEï¼Œè¶…æ—¶æ—¶é—´ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œæ’é˜Ÿç­–ç•¥æ˜¯Â DelayedWorkQueueï¼Œé€‚åˆç”¨äºæ‰§è¡Œå®šæ—¶ä»»åŠ¡å’Œå…·æœ‰å›ºå®šå‘¨æœŸçš„é‡å¤ä»»åŠ¡ã€‚

SingleThreadExecutor

```java
public static ExecutorService newSingleThreadExecutor() {
    return new FinalizableDelegatedExecutorService
        (new ThreadPoolExecutor(1, 1,
                                0L, TimeUnit.MILLISECONDS,
                                new LinkedBlockingQueue<Runnable>()));
}
```

ç‰¹ç‚¹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½æ˜¯ 1 ï¼Œå³åªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ã€‚æ²¡æœ‰è¶…æ—¶æ—¶é—´ã€‚æ’é˜Ÿç­–ç•¥æ˜¯Â LinkedBlockingQueueï¼Œå®ƒèƒ½ç¡®ä¿æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…é¡ºåºæ‰§è¡Œï¼Œä½¿å¾—è¿™äº›ä»»åŠ¡ä¹‹é—´ä¸éœ€è¦å¤„ç†çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚

**æ’é˜Ÿç­–ç•¥**
 
ä¸Šé¢è¯´åˆ°çš„ä¸åŒæ’é˜Ÿç­–ç•¥å¯¹åº”ç€ä¸åŒçš„é˜»å¡é˜Ÿåˆ—å®ç°ï¼š

| å®ç°ç±» | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| LinkedBlockingQueue | æ— ç•Œé˜Ÿåˆ— | åŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰ç…§FIFOåŸåˆ™å¯¹å…ƒç´ æ’åº |
| SynchronousQueue | åŒæ­¥é˜Ÿåˆ— | ä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¼šä¸€ç›´é˜»å¡ |
| DelayedWorkQueue | æ— ç•Œé˜»å¡å»¶æ—¶é˜Ÿåˆ— |  |


[https://mp.weixin.qq.com/s/baYuX8aCwQ9PP6k7TDl2Ww](https://mp.weixin.qq.com/s/baYuX8aCwQ9PP6k7TDl2Ww)
